window.EDD_EU_VAT=function(e,t,a,d){t.euCountries=d.countries;const n="1"===edd_eu_vat_params.debug_mode,r=edd_eu_vat_params.checkout_updated_cart_selector,c=edd_eu_vat_params.checkout_form_selector,o=[];function i(e,t=""){n&&(o.push({message:e,data:t,date:(new Date).toLocaleString()}),localStorage.setItem("euVatLogger",JSON.stringify(o)))}function u(){e("#edd-vat-check-result").remove()}function s(e,t){e.append('<span id="edd-vat-check-result" class="edd-vat-check-result edd-vat-check-error">'+t+"</span>")}var l=function(t){var n=e("#edd-card-vat-wrap"),o=e("#billing_country").val(),l=e("#edd-vat-number").val();if(i("eddVatCheck running",{billingCountry:o,vatNumber:l}),!n.length)return!1;if(n.data("check"))return!1;if(u(),!l)return s(n,d.messages.vat_number_missing),!1;if(!o)return s(n,d.messages.country_missing),!1;var _={action:"edd_vat_check",billing_country:o,vat_number:l,nonce:e("#edd-checkout-address-fields-nonce").val()};n.data("check",!0);var h=e('<span class="edd-loading-ajax edd-loading"></span>');return e("#edd-vat-check-button").after(h),e(a.body).trigger("edd_eu_vat:before_vat_check",_),e.ajax({type:"POST",data:_,dataType:"json",url:edd_global_vars.ajaxurl,xhrFields:{withCredentials:!0}}).done((function(t,o,i){if(200==i.status&&void 0!==t.html){var u=e(e.parseHTML(t.html.trim())).filter(r);u.length&&e(c).replaceWith(u),e(".edd_cart_amount").html(t.total),n.append(t.vat_check_result),0===t.tax_rate_raw&&d.hide_edd_sl_notices&&(e("#edd-recurring-sl-auto-renew").each((function(){e(this).remove()})),e("#edd-recurring-sl-cancel-replace").each((function(){e(this).remove()})));var l={postdata:_,response:t};e(a.body).trigger("edd_taxes_recalculated",l).trigger("edd_eu_vat:vat_check",t)}else s(n,d.messages.ajax_error)})).fail((function(e,t,a){s(n,d.messages.ajax_error)})).always((function(){h.remove(),n.data("check",!1),e(a.body).trigger("edd_eu_vat:vat_check_complete")})),!1};function _(){if(d.countries){var t=e("#billing_country").val();i("eddCountryCheck running",""),t&&-1!==d.countries.indexOf(t)?(e("#edd-card-vat-wrap").show(),i("eddCountryCheck showing #edd-cart-vat-wrap","")):(e("#edd-card-vat-wrap").hide(),u(),i("eddCountryCheck hiding #edd-cart-vat-wrap",""))}}return e((function(){e("#edd_purchase_form").on("click","#edd-vat-check-button",l).on("change","#billing_country",(function(t){i("#billing_country changed",e(this).val());var a=e("#edd-vat-check-result").data();a&&a.valid&&a.country&&a.country!==e(this).val()&&(e("#edd-vat-number").val(""),u()),_()})).on("change","#edd-stripe-update-billing-address",(function(e){i("#edd-stripe-update-billing-address changed",""),_()}))})),e(a.body).on("edd_gateway_loaded",(function(t,a){i("running eddCountryCheck on edd_gateway_loaded event"),_(),e("#edd-stripe-add-new").on("change",(function(e){i("running eddCountryCheck on #edd-stripe-add-new click"),_()}))})),e((function(){e("#edd_purchase_form").on("change","#billing_country",(function(t){e("#edd-purchase-button, #billing_country").attr("disabled",!0)}))})),e(a.body).on("edd_taxes_recalculated",(function(t,a){const d=e(".edd_cart_amount"),n=a?.response?.total_raw;void 0!==n&&d.attr("data-total",n),i("updating data-total attribute",{rawTax:n}),e("#edd-purchase-button, #billing_country").removeAttr("disabled")})),{checkVatNumber:l,checkCountry:_}}(jQuery,window,document,edd_eu_vat_params);